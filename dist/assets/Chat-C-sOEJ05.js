import{r as t,j as a}from"./main-CHOg9Uja.js";function U(){const[n,N]=t.useState(null),[f,C]=t.useState(!0),[l,w]=t.useState(null),d=t.useCallback(async()=>{try{C(!0),w(null);const r=window.location.hostname==="localhost"||window.location.hostname.includes("localhost");if(console.log("Environment check:",{DEV:!1,MODE:"production",hostname:window.location.hostname,isDevelopment:r}),r){console.log("Development mode: Using mock configuration"),N({authSecret:"dev-mock-secret-key-123",environment:"development",apiBase:"/api",features:{chat:!0,diagnostics:!0,recording:!1},rateLimits:{roomCreation:50,chatMessages:60,apiCalls:2e3}}),C(!1);return}const s=await fetch("/api/config");if(!s.ok)throw new Error(`Failed to fetch config: ${s.status}`);const e=await s.json();if(e.success&&e.config)console.log("Setting config:",e.config),N(e.config);else throw new Error("Invalid config response format")}catch(r){console.error("Failed to fetch client configuration:",r),w(r.message),N(null)}finally{C(!1)}},[]);t.useEffect(()=>{d()},[d]);const b=t.useCallback(async()=>{try{if(window.location.hostname==="localhost"||window.location.hostname.includes("localhost"))return console.log("Development mode: Mock room creation"),{success:!0,roomId:"dev-mock-room-"+Math.random().toString(36).substr(2,9),message:"Mock room created successfully"};console.log("Creating room with config:",n);const s={"Content-Type":"application/json",...n?.authSecret&&{"x-auth-secret":n.authSecret}};console.log("Request headers:",s);const e=await fetch("/api/create-room",{method:"POST",headers:s});if(!e.ok){let h="";try{h=await e.text()}catch{h="Unable to read error response"}throw console.error("Room creation failed:",{status:e.status,statusText:e.statusText,body:h,headers:e.headers?Object.fromEntries(e.headers.entries()):"No headers"}),new Error(`Failed to create room: ${e.status} ${e.statusText}${h?` - ${h}`:""}`)}return await e.json()}catch(r){throw console.error("Error creating room:",r),r}},[n]),$=t.useCallback(async(r,s,e,i=null)=>{try{if(window.location.hostname==="localhost"||window.location.hostname.includes("localhost"))return{ok:!0,message:{id:Date.now().toString(),roomId:r,sender:e,message:s,timestamp:Date.now()}};const y=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json",...n?.authSecret&&{"x-auth-secret":n.authSecret}},body:JSON.stringify({roomId:r,message:s,sender:e,...i&&{secret:i}})});if(!y.ok)throw new Error(`Failed to send message: ${y.status}`);return await y.json()}catch(h){throw console.error("Error sending chat message:",h),h}},[n]),p=t.useCallback(async(r,s=0)=>{try{if(window.location.hostname==="localhost"||window.location.hostname.includes("localhost"))return{messages:[],success:!0};const i=await fetch(`/api/chat?roomId=${r}&since=${s}`);if(!i.ok)throw new Error(`Failed to get messages: ${i.status}`);return await i.json()}catch(e){throw console.error("Error getting chat messages:",e),e}},[]),E=t.useCallback(async(r,s)=>{try{const e=await fetch("/api/offer",{method:"POST",headers:{"Content-Type":"application/json",...n?.authSecret&&{"x-auth-secret":n.authSecret}},body:JSON.stringify({roomId:r,desc:s})});if(!e.ok)throw new Error(`Failed to send offer: ${e.status}`);return await e.json()}catch(e){throw console.error("Error sending offer:",e),e}},[n]),j=t.useCallback(async r=>{try{const s=await fetch(`/api/offer?roomId=${r}`);if(!s.ok){if(s.status===404)return null;throw new Error(`Failed to get offer: ${s.status}`)}return await s.json()}catch(s){throw console.error("Error getting offer:",s),s}},[]),k=t.useCallback(async(r,s)=>{try{const e=await fetch("/api/answer",{method:"POST",headers:{"Content-Type":"application/json",...n?.authSecret&&{"x-auth-secret":n.authSecret}},body:JSON.stringify({roomId:r,desc:s})});if(!e.ok)throw new Error(`Failed to send answer: ${e.status}`);return await e.json()}catch(e){throw console.error("Error sending answer:",e),e}},[n]),x=t.useCallback(async r=>{try{const s=await fetch(`/api/answer?roomId=${r}`);if(!s.ok){if(s.status===404)return null;throw new Error(`Failed to get answer: ${s.status}`)}return await s.json()}catch(s){throw console.error("Error getting answer:",s),s}},[]),v=t.useCallback(async(r,s,e)=>{try{const i=await fetch("/api/candidate",{method:"POST",headers:{"Content-Type":"application/json",...n?.authSecret&&{"x-auth-secret":n.authSecret}},body:JSON.stringify({roomId:r,role:s,candidate:e})});if(!i.ok)throw new Error(`Failed to send ICE candidate: ${i.status}`);return await i.json()}catch(i){throw console.error("Error sending ICE candidate:",i),i}},[n]),S=t.useCallback(async(r,s)=>{try{const e=await fetch(`/api/candidate?roomId=${r}&role=${s}`);if(!e.ok)throw new Error(`Failed to get ICE candidates: ${e.status}`);return await e.json()}catch(e){throw console.error("Error getting ICE candidates:",e),e}},[]),g=t.useCallback(async(r,s)=>{try{const e=await fetch(`/api/diagnostics?roomId=${r}&role=${s}`);if(!e.ok)throw new Error(`Failed to get diagnostics: ${e.status}`);return await e.json()}catch(e){throw console.error("Error getting diagnostics:",e),e}},[]);return{config:n,loading:f,error:l,fetchConfig:d,createRoom:b,sendChatMessage:$,getChatMessages:p,sendOffer:E,getOffer:j,sendAnswer:k,getAnswer:x,sendICECandidate:v,getICECandidates:S,getDiagnostics:g}}function q(n,N,f,C=null){const[l,w]=t.useState([]),[d,b]=t.useState(!1),[$,p]=t.useState(null),[E,j]=t.useState(!1),[k,x]=t.useState(0),{sendChatMessage:v,getChatMessages:S}=U(),g=t.useRef(null),r=t.useRef(null),s=t.useCallback(async()=>{if(!(!n||!E))try{const c=await S(n,k);c.messages&&c.messages.length>0&&w(u=>{const m=new Set(u.map(T=>T.id)),D=c.messages.filter(T=>!m.has(T.id));if(D.length>0){const T=Math.max(...D.map(F=>F.timestamp));return x(T),[...u,...D].sort((F,P)=>F.timestamp-P.timestamp)}return u})}catch(c){console.error("Error polling messages:",c),p("Failed to fetch messages"),j(!1),r.current&&clearTimeout(r.current),r.current=setTimeout(()=>{j(!0),p(null)},5e3)}},[n,k,E,S]),e=t.useCallback(()=>{g.current&&clearInterval(g.current),g.current=setInterval(s,2e3)},[s]),i=t.useCallback(()=>{g.current&&(clearInterval(g.current),g.current=null)},[]);t.useEffect(()=>(n&&f?(j(!0),p(null),w([]),x(0),e()):(j(!1),i()),()=>{i(),r.current&&clearTimeout(r.current)}),[n,f,C,e,i]);const h=t.useCallback(async(c,u=f)=>{if(!n||!u||!c.trim())throw new Error("Room ID, sender, and message are required");try{b(!0),p(null);const m=await v(n,c,u,C);if(m.ok){const D={id:m.message.id,sender:u,message:c,timestamp:m.message.timestamp};return w(T=>[...T,D].sort((F,P)=>F.timestamp-P.timestamp)),x(m.message.timestamp),m.message}else throw new Error("Failed to send message")}catch(m){throw console.error("Error sending message:",m),p(`Failed to send message: ${m.message}`),m}finally{b(!1)}},[n,f,v]),y=t.useCallback(async()=>{if(n)try{b(!0),p(null);const c=await S(n,0);if(c.messages&&(w(c.messages.sort((u,m)=>u.timestamp-m.timestamp)),c.messages.length>0)){const u=Math.max(...c.messages.map(m=>m.timestamp));x(u)}}catch(c){console.error("Error loading initial messages:",c),p("Failed to load messages")}finally{b(!1)}},[n,S]);t.useEffect(()=>{n&&y()},[n,y]);const R=t.useCallback(()=>{w([]),x(0),p(null)},[]),O=t.useCallback(()=>l.length,[l]),o=t.useCallback(c=>l.filter(u=>u.sender===c),[l]),M=t.useCallback(()=>l.length>0?l[l.length-1]:null,[l]),I=t.useCallback(c=>l.some(u=>u.sender===c),[l]),A=t.useCallback(()=>{const c=new Set(l.map(u=>u.sender));return Array.from(c)},[l]),L=t.useCallback(c=>({...c,formattedTime:new Date(c.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),formattedDate:new Date(c.timestamp).toLocaleDateString(),isFromCurrentUser:c.sender===f}),[f]),J=t.useCallback(()=>l.map(L),[l,L]);return t.useEffect(()=>()=>{i(),r.current&&clearTimeout(r.current)},[i]),{messages:l,loading:d,error:$,isConnected:E,lastMessageTime:k,sendMessage:h,clearMessages:R,loadInitialMessages:y,getMessageCount:O,getMessagesBySender:o,getLatestMessage:M,hasSenderSentMessages:I,getUniqueSenders:A,getFormattedMessages:J}}function B({roomId:n,role:N,viewerId:f,senderSecret:C}){const[l,w]=t.useState(""),[d,b]=t.useState(f||N),[$,p]=t.useState(!1),[E,j]=t.useState(!1),k=t.useRef(null),x=t.useRef(null),{messages:v,sendMessage:S,loading:g,error:r,isConnected:s}=q(n,N,d,C);t.useEffect(()=>{k.current?.scrollIntoView({behavior:"smooth"})},[v]),t.useEffect(()=>{f&&b(f)},[f]);const e=()=>{p(!0),x.current&&clearTimeout(x.current),x.current=setTimeout(()=>{p(!1)},1e3)},i=o=>{w(M=>M+o),j(!1)},h=async o=>{if(o.preventDefault(),!(!l.trim()||!d.trim()))try{await S(l.trim(),d.trim()),w("")}catch(M){console.error("Error sending message:",M)}},y=o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),h(o))},R=o=>new Date(o).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),O=o=>o==="host"?"🖥️ Host":o.startsWith("viewer_")?`👀 ${o}`:`👤 ${o}`;return a.jsxs("div",{className:"flex flex-col h-full bg-white",children:[a.jsxs("div",{className:"flex-shrink-0 bg-blue-600 text-white p-4",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("h3",{className:"text-lg font-semibold",children:"💬 Chat"}),a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx("div",{className:`w-2 h-2 rounded-full ${s?"bg-green-400":"bg-red-400"}`}),a.jsx("span",{className:"text-sm",children:s?"Connected":"Disconnected"})]})]}),a.jsxs("p",{className:"text-blue-100 text-sm mt-1",children:["Room: ",n]})]}),a.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[g&&v.length===0&&a.jsxs("div",{className:"text-center text-gray-500 py-4",children:[a.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),"Loading messages..."]}),r&&a.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:a.jsxs("div",{className:"text-red-600 text-sm",children:["⚠️ ",r]})}),v.length===0&&!g&&a.jsxs("div",{className:"text-center text-gray-500 py-8",children:[a.jsx("div",{className:"text-4xl mb-2",children:"💬"}),a.jsx("p",{children:"No messages yet"}),a.jsx("p",{className:"text-sm",children:"Start the conversation!"})]}),v.map(o=>a.jsx("div",{className:`flex ${o.sender===d?"justify-end":"justify-start"}`,children:a.jsxs("div",{className:`max-w-xs lg:max-w-md px-3 py-2 rounded-lg ${o.sender===d?"bg-blue-600 text-white":"bg-gray-100 text-gray-900"}`,children:[o.sender!==d&&a.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:O(o.sender)}),a.jsx("div",{className:"text-sm whitespace-pre-wrap break-words",children:o.message}),a.jsx("div",{className:`text-xs mt-1 ${o.sender===d?"text-blue-100":"text-gray-500"}`,children:R(o.timestamp)})]})},o.id)),a.jsx("div",{ref:k})]}),a.jsx("div",{className:"flex-shrink-0 border-t bg-gray-50 p-4",children:a.jsxs("form",{onSubmit:h,className:"space-y-3",children:[a.jsx("div",{children:a.jsx("input",{type:"text",value:d,onChange:o=>b(o.target.value),placeholder:"Your name",className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",maxLength:50})}),a.jsxs("div",{className:"flex space-x-2",children:[a.jsxs("div",{className:"flex-1 relative",children:[a.jsx("textarea",{value:l,onChange:o=>{w(o.target.value),e()},onKeyPress:y,placeholder:"Type your message... (Enter to send, Shift+Enter for new line)",className:"w-full px-3 py-2 pr-10 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none",rows:2,maxLength:500}),a.jsx("button",{type:"button",onClick:()=>j(!E),className:"absolute right-2 top-2 text-gray-400 hover:text-gray-600",children:"😊"})]}),a.jsx("button",{type:"submit",disabled:!l.trim()||!d.trim()||g,className:`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${!l.trim()||!d.trim()||g?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:g?a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):"Send"})]}),E&&a.jsx("div",{className:"absolute bottom-16 left-4 bg-white border border-gray-300 rounded-lg shadow-lg p-2 max-h-32 overflow-y-auto",children:a.jsx("div",{className:"grid grid-cols-8 gap-1",children:["😀","😂","😍","🤔","👍","👎","❤️","🔥","💯","🎉","🚀","⭐","💡","🎯","🔥","💪"].map(o=>a.jsx("button",{type:"button",onClick:()=>i(o),className:"p-1 hover:bg-gray-100 rounded text-lg",children:o},o))})}),$&&a.jsxs("div",{className:"text-xs text-gray-500 italic",children:[d," is typing..."]}),a.jsxs("div",{className:"flex justify-between text-xs text-gray-500",children:[a.jsxs("span",{children:[l.length,"/500 characters"]}),a.jsx("span",{children:"Press Enter to send, Shift+Enter for new line"})]})]})}),!s&&a.jsx("div",{className:"flex-shrink-0 bg-yellow-50 border-t border-yellow-200 p-3",children:a.jsxs("div",{className:"flex items-center text-yellow-800",children:[a.jsx("div",{className:"w-2 h-2 bg-yellow-400 rounded-full mr-2"}),a.jsx("span",{className:"text-sm",children:"Reconnecting to chat..."})]})})]})}export{B as default};
//# sourceMappingURL=Chat-C-sOEJ05.js.map
