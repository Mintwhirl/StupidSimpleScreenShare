import{r as o,j as X}from"./main-DJ8pVtEy.js";const q=o.forwardRef(({className:c,...r},a)=>{const p=o.useRef(null),I=a||p;return o.useImperativeHandle(a,()=>p.current,[]),o.useEffect(()=>{const t=I.current;if(!t)return;const T=()=>{console.log("Video metadata loaded:",{duration:t.duration,videoWidth:t.videoWidth,videoHeight:t.videoHeight})},w=()=>{console.log("Video data loaded")},h=()=>{console.log("Video can start playing")},C=()=>{console.log("Video started playing")},N=()=>{console.log("Video paused")},d=()=>{console.log("Video ended")},O=_=>{console.error("Video error:",_)},D=()=>{console.log("Video waiting for data")},S=()=>{console.log("Video stalled")};return t.addEventListener("loadedmetadata",T),t.addEventListener("loadeddata",w),t.addEventListener("canplay",h),t.addEventListener("play",C),t.addEventListener("pause",N),t.addEventListener("ended",d),t.addEventListener("error",O),t.addEventListener("waiting",D),t.addEventListener("stalled",S),()=>{t.removeEventListener("loadedmetadata",T),t.removeEventListener("loadeddata",w),t.removeEventListener("canplay",h),t.removeEventListener("play",C),t.removeEventListener("pause",N),t.removeEventListener("ended",d),t.removeEventListener("error",O),t.removeEventListener("waiting",D),t.removeEventListener("stalled",S)}},[I]),X.jsx("video",{ref:I,className:c,"aria-label":"Screen sharing video stream",...r})});q.displayName="VideoPlayer";var G={};const z=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"}],W=[{urls:"turn:openrelay.metered.ca:80",username:"openrelayproject",credential:"openrelayproject"},{urls:"turn:openrelay.metered.ca:443",username:"openrelayproject",credential:"openrelayproject"},{urls:"turn:openrelay.metered.ca:443?transport=tcp",username:"openrelayproject",credential:"openrelayproject"},...G.TURN_SERVERS?JSON.parse(G.TURN_SERVERS):[]];function Q(c=!1){const r=[...z];return c&&W.length>0&&r.push(...W),r}const F=window.location.hostname==="localhost"||window.location.hostname.includes("localhost"),L={ERROR:0,WARN:1,INFO:2,DEBUG:3},A=F?L.DEBUG:L.ERROR;class u{static error(r,...a){A>=L.ERROR&&console.error(`[ERROR] ${r}`,...a)}static warn(r,...a){A>=L.WARN&&console.warn(`[WARN] ${r}`,...a)}static info(r,...a){A>=L.INFO&&console.info(`[INFO] ${r}`,...a)}static debug(r,...a){A>=L.DEBUG&&console.debug(`[DEBUG] ${r}`,...a)}static webrtc(r,a={}){F&&console.debug(`[WebRTC] ${r}`,a)}static api(r,a,p={}){F&&console.debug(`[API] ${r} ${a}`,p)}static user(r,a={}){F&&console.debug(`[USER] ${r}`,a)}}const te={DISCONNECTED:"disconnected",CONNECTING:"connecting",CONNECTED:"connected"},ne={ROOM_NOT_FOUND:"Room not found. Please check the room ID and make sure the host has started sharing.",CONNECTION_FAILED:"Failed to connect to host. Please check the room ID and try again.",SCREEN_SHARE_FAILED:"Failed to start screen sharing. Please check your browser permissions.",INVALID_ROOM_ID:"Room ID must be exactly 24 characters and contain only letters and numbers",INVALID_VIEWER_ID:"Viewer ID can only contain letters, numbers, spaces, hyphens, and underscores",CONNECTION_TIMEOUT:"Connection timeout. Please try again."},re={CONNECT_TO_HOST:"Connect to Host",DISCONNECT:"Disconnect",RECONNECT:"Reconnect",CONNECTING:"Connecting...",CONNECTED:"Connected",DISCONNECTED:"Disconnected",HOST_ONLINE:"Host Online",HOST_OFFLINE:"Host Offline",CONNECTING_TO_HOST:"Connecting to Host...",UNKNOWN:"Unknown"},ae={SUCCESS:"text-green-600",WARNING:"text-yellow-600",ERROR:"text-red-600",DEFAULT:"text-gray-600"},Y={DEFAULT:1e3},oe={CONFIG:"/api/config",CREATE_ROOM:"/api/create-room",OFFER:"/api/offer",ANSWER:"/api/answer",CANDIDATE:"/api/candidate",CHAT:"/api/chat",DIAGNOSTICS:"/api/diagnostics",VIEWERS:"/api/viewers",REGISTER_SENDER:"/api/register-sender"};function Z(c,r={}){const{initialInterval:a=Y.DEFAULT,maxInterval:p=3e4,backoffFactor:I=1.5,maxPolls:t=60,backoffAfter:T=10}=r;return async()=>{let w=0,h=a;const C=async()=>{if(w++,w>t)throw new Error("Polling timeout reached");const N=await c();return N||(w>T&&(h=Math.min(h*I,p)),new Promise((d,O)=>{const D=setTimeout(async()=>{try{const S=await C();d(S)}catch(S){O(S)}},h);C.timeoutId=D}))};return C()}}function se(c,r,a,p=null){const[I,t]=o.useState("disconnected"),[T,w]=o.useState(null),[h,C]=o.useState(null),[N,d]=o.useState(null),[O,D]=o.useState({}),[S,_]=o.useState([]),m=o.useRef(null),M=o.useRef(null),i=o.useRef(null),l=o.useRef(null),v=o.useRef(null),y=o.useRef(!0);o.useEffect(()=>{const e=Q(a?.useTurn!==!1);_(e)},[a]);const $=o.useCallback(async e=>{if(!(!c||!r))try{const n=await fetch("/api/candidate",{method:"POST",headers:{"Content-Type":"application/json",...a?.authSecret&&{"x-auth-secret":a.authSecret}},body:JSON.stringify({roomId:c,role:r,viewerId:p,candidate:e})});if(!n.ok)throw new Error(`Failed to send ICE candidate: ${n.status}`)}catch(n){u.error("Error sending ICE candidate:",n),d(`Failed to send ICE candidate: ${n.message}`)}},[c,r,a,p]),k=o.useCallback(()=>{const e=new RTCPeerConnection({iceServers:S});return e.onicecandidate=n=>{n.candidate&&$(n.candidate)},e.onconnectionstatechange=()=>{u.webrtc("Connection state changed",{state:e.connectionState}),t(e.connectionState),(e.connectionState==="connected"||e.connectionState==="failed")&&(i.current&&(clearInterval(i.current),i.current=null),l.current&&(clearInterval(l.current),l.current=null),v.current&&(clearInterval(v.current),v.current=null))},e.oniceconnectionstatechange=()=>{u.webrtc("ICE connection state changed",{state:e.iceConnectionState})},e.ontrack=n=>{u.webrtc("Received remote stream",{stream:n.streams[0]}),w(n.streams[0])},e.ondatachannel=n=>{const f=n.channel;M.current=f,f.onopen=()=>{u.webrtc("Data channel opened")},f.onmessage=E=>{u.webrtc("Received data channel message",{data:E.data})}},e},[S,$]),V=o.useCallback(async e=>{if(c)try{const n=await fetch("/api/offer",{method:"POST",headers:{"Content-Type":"application/json",...a?.authSecret&&{"x-auth-secret":a.authSecret}},body:JSON.stringify({roomId:c,desc:e})});if(!n.ok)throw new Error(`Failed to send offer: ${n.status}`)}catch(n){u.error("Error sending offer:",n),d(`Failed to send offer: ${n.message}`)}},[c,a]),x=o.useCallback(async e=>{if(c)try{const n=await fetch("/api/answer",{method:"POST",headers:{"Content-Type":"application/json",...a?.authSecret&&{"x-auth-secret":a.authSecret}},body:JSON.stringify({roomId:c,desc:e})});if(!n.ok)throw new Error(`Failed to send answer: ${n.status}`)}catch(n){u.error("Error sending answer:",n),d(`Failed to send answer: ${n.message}`)}},[c,a]),U=o.useCallback(async()=>{i.current&&clearInterval(i.current);let e=0,n=1e3;const f=60,E=async()=>{try{if(e++,e>f){clearInterval(i.current),i.current=null,y.current&&(d("Connection timeout: No offer received from host. Make sure the host has started sharing."),t("failed"));return}const s=await fetch(`/api/offer?roomId=${c}`);if(s.ok){const R=await s.json();if(R.desc){clearInterval(i.current),i.current=null;const g=k();m.current=g,await g.setRemoteDescription(R.desc);const H=await g.createAnswer();await g.setLocalDescription(H),await x(H),b()}}else s.status===404?e>10&&(clearInterval(i.current),n=5e3,i.current=setInterval(E,n)):(u.error("Unexpected error polling for offers:",s.status),clearInterval(i.current),i.current=null,y.current&&(d(`Server error: ${s.status}`),t("failed")))}catch(s){u.error("Error polling for offers:",s),clearInterval(i.current),i.current=null,y.current&&(d(`Network error: ${s.message}`),t("failed"))}};i.current=setInterval(E,n)},[c,x,k,b]),j=o.useCallback(async()=>{l.current&&clearInterval(l.current);let e=0,n=1e3;const f=60,E=async()=>{try{if(e++,e>f){clearInterval(l.current),l.current=null,y.current&&(d("Connection timeout: No answer received from viewer. Make sure the viewer has connected."),t("failed"));return}const s=await fetch(`/api/answer?roomId=${c}`);if(s.ok){const R=await s.json();if(R.desc){clearInterval(l.current),l.current=null;const g=m.current;g&&await g.setRemoteDescription(R.desc)}}else s.status===404?e>10&&(clearInterval(l.current),n=5e3,l.current=setInterval(E,n)):(u.error("Unexpected error polling for answers:",s.status),clearInterval(l.current),l.current=null,y.current&&(d(`Server error: ${s.status}`),t("failed")))}catch(s){u.error("Error polling for answers:",s),clearInterval(l.current),l.current=null,y.current&&(d(`Network error: ${s.message}`),t("failed"))}};l.current=setInterval(E,n)},[c]),b=o.useCallback(async()=>{v.current&&clearInterval(v.current);const n=Z(async()=>{const f=await fetch(`/api/candidate?roomId=${c}&role=${r}${p?`&viewerId=${p}`:""}`);if(f.ok){const E=await f.json();if(E.candidates&&E.candidates.length>0){const s=m.current;if(s)for(const R of E.candidates)try{await s.addIceCandidate(R)}catch(g){u.warn("Failed to add ICE candidate:",g)}return!0}}else if(f.status!==404)throw u.error("Error polling for ICE candidates:",f.status),new Error(`HTTP ${f.status}`);return!1},{initialInterval:1e3,maxInterval:1e4,backoffFactor:1.5,maxPolls:120,backoffAfter:10});try{await n()}catch{u.warn("ICE candidate polling timeout - connection may be stuck")}},[c,r,p]),B=o.useCallback(async()=>{if(r!=="host")throw new Error("Only hosts can start screen sharing");try{d(null),t("connecting");const e=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0}),n=e.getVideoTracks(),f=e.getAudioTracks();if(n.length===0)throw new Error("Video permission denied - cannot share screen without video");f.length===0&&u.warn("Audio permission denied - screen sharing will be video-only"),C(e);const E=k();m.current=E,e.getTracks().forEach(R=>{const g=E.addTransceiver(R,{streams:[e],direction:"sendonly"})});const s=await E.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});return await E.setLocalDescription(s),await V(s),j(),b(),e}catch(e){throw u.error("Error starting screen share:",e),d(`Failed to start screen sharing: ${e.message}`),t("disconnected"),e}},[r,k,V,j,b]),J=o.useCallback(async()=>{if(r!=="viewer")throw new Error("Only viewers can connect to host");try{d(null),t("connecting"),U()}catch(e){throw u.error("Error connecting to host:",e),d(`Failed to connect to host: ${e.message}`),t("disconnected"),e}},[r,U]),P=o.useCallback(async()=>{try{h&&(h.getTracks().forEach(e=>e.stop()),C(null)),m.current&&(m.current.close(),m.current=null),i.current&&(clearInterval(i.current),i.current=null),l.current&&(clearInterval(l.current),l.current=null),v.current&&(clearInterval(v.current),v.current=null),t("disconnected"),w(null)}catch(e){u.error("Error stopping screen share:",e),d(`Failed to stop screen sharing: ${e.message}`)}},[h]),K=o.useCallback(async()=>{await P()},[P]);return o.useEffect(()=>()=>{y.current=!1,i.current&&clearInterval(i.current),l.current&&clearInterval(l.current),v.current&&clearInterval(v.current),m.current&&m.current.close(),h&&h.getTracks().forEach(e=>e.stop())},[h]),{connectionState:I,remoteStream:T,localStream:h,error:N,peerConnections:O,startScreenShare:B,stopScreenShare:P,connectToHost:J,disconnect:K}}export{oe as A,te as C,ne as E,ae as S,re as U,q as V,se as u};
//# sourceMappingURL=useWebRTC-BtBAL5T8.js.map
