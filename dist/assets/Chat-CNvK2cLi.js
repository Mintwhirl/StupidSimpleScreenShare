import{r as t,a as z,j as e}from"./main-BQb3GjsF.js";function B(l,R,u,D=null){const[r,g]=t.useState([]),[c,h]=t.useState(!1),[L,d]=t.useState(null),[j,f]=t.useState(!1),[w,x]=t.useState(0),{sendChatMessage:p,getChatMessages:v}=z(),o=t.useRef(null),m=t.useRef(null),N=t.useCallback(async()=>{if(!(!l||!j))try{const a=await v(l,w);a.messages&&a.messages.length>0&&g(n=>{const i=new Set(n.map(y=>y.id)),k=a.messages.filter(y=>!i.has(y.id));if(k.length>0){const y=Math.max(...k.map(E=>E.timestamp));return x(y),[...n,...k].sort((E,F)=>E.timestamp-F.timestamp)}return n})}catch(a){console.error("Error polling messages:",a),d("Failed to fetch messages"),f(!1),m.current&&clearTimeout(m.current),m.current=setTimeout(()=>{f(!0),d(null)},5e3)}},[l,w,j,v]),M=t.useCallback(()=>{o.current&&clearInterval(o.current),o.current=setInterval(N,2e3)},[N]),b=t.useCallback(()=>{o.current&&(clearInterval(o.current),o.current=null)},[]);t.useEffect(()=>(l&&u?(f(!0),d(null),g([]),x(0),M()):(f(!1),b()),()=>{b(),m.current&&clearTimeout(m.current)}),[l,u,M,b]);const T=t.useCallback(async(a,n=u)=>{if(!l||!n||!a.trim())throw new Error("Room ID, sender, and message are required");try{h(!0),d(null);const i=await p(l,a,n,D);if(i.ok){const k={id:i.message.id,sender:n,message:a,timestamp:i.message.timestamp};return g(y=>[...y,k].sort((E,F)=>E.timestamp-F.timestamp)),x(i.message.timestamp),i.message}else throw new Error("Failed to send message")}catch(i){throw console.error("Error sending message:",i),d(`Failed to send message: ${i.message}`),i}finally{h(!1)}},[l,u,p]),C=t.useCallback(async()=>{if(l)try{h(!0),d(null);const a=await v(l,0);if(a.messages&&(g(a.messages.sort((n,i)=>n.timestamp-i.timestamp)),a.messages.length>0)){const n=Math.max(...a.messages.map(i=>i.timestamp));x(n)}}catch(a){console.error("Error loading initial messages:",a),d("Failed to load messages")}finally{h(!1)}},[l,v]);t.useEffect(()=>{l&&C()},[l,C]);const $=t.useCallback(()=>{g([]),x(0),d(null)},[]),P=t.useCallback(()=>r.length,[r]),s=t.useCallback(a=>r.filter(n=>n.sender===a),[r]),S=t.useCallback(()=>r.length>0?r[r.length-1]:null,[r]),q=t.useCallback(a=>r.some(n=>n.sender===a),[r]),A=t.useCallback(()=>{const a=new Set(r.map(n=>n.sender));return Array.from(a)},[r]),K=t.useCallback(a=>({...a,formattedTime:new Date(a.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),formattedDate:new Date(a.timestamp).toLocaleDateString(),isFromCurrentUser:a.sender===u}),[u]),U=t.useCallback(()=>r.map(K),[r,K]);return t.useEffect(()=>()=>{b(),m.current&&clearTimeout(m.current)},[b]),{messages:r,loading:c,error:L,isConnected:j,lastMessageTime:w,sendMessage:T,clearMessages:$,loadInitialMessages:C,getMessageCount:P,getMessagesBySender:s,getLatestMessage:S,hasSenderSentMessages:q,getUniqueSenders:A,getFormattedMessages:U}}function H({roomId:l,role:R,viewerId:u,senderSecret:D}){const[r,g]=t.useState(""),[c,h]=t.useState(u||R),[L,d]=t.useState(!1),[j,f]=t.useState(!1),w=t.useRef(null),x=t.useRef(null),{messages:p,sendMessage:v,loading:o,error:m,isConnected:N}=B(l,R,c,D);t.useEffect(()=>{w.current?.scrollIntoView({behavior:"smooth"})},[p]),t.useEffect(()=>{u&&h(u)},[u]);const M=()=>{d(!0),x.current&&clearTimeout(x.current),x.current=setTimeout(()=>{d(!1)},1e3)},b=s=>{g(S=>S+s),f(!1)},T=async s=>{if(s.preventDefault(),!(!r.trim()||!c.trim()))try{await v(r.trim(),c.trim()),g("")}catch(S){console.error("Error sending message:",S)}},C=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),T(s))},$=s=>new Date(s).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),P=s=>s==="host"?"🖥️ Host":s.startsWith("viewer_")?`👀 ${s}`:`👤 ${s}`;return e.jsxs("div",{className:"flex flex-col h-full bg-white",children:[e.jsxs("div",{className:"flex-shrink-0 bg-blue-600 text-white p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"💬 Chat"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${N?"bg-green-400":"bg-red-400"}`}),e.jsx("span",{className:"text-sm",children:N?"Connected":"Disconnected"})]})]}),e.jsxs("p",{className:"text-blue-100 text-sm mt-1",children:["Room: ",l]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[o&&p.length===0&&e.jsxs("div",{className:"text-center text-gray-500 py-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),"Loading messages..."]}),m&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsxs("div",{className:"text-red-600 text-sm",children:["⚠️ ",m]})}),p.length===0&&!o&&e.jsxs("div",{className:"text-center text-gray-500 py-8",children:[e.jsx("div",{className:"text-4xl mb-2",children:"💬"}),e.jsx("p",{children:"No messages yet"}),e.jsx("p",{className:"text-sm",children:"Start the conversation!"})]}),p.map(s=>e.jsx("div",{className:`flex ${s.sender===c?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs lg:max-w-md px-3 py-2 rounded-lg ${s.sender===c?"bg-blue-600 text-white":"bg-gray-100 text-gray-900"}`,children:[s.sender!==c&&e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:P(s.sender)}),e.jsx("div",{className:"text-sm whitespace-pre-wrap break-words",children:s.message}),e.jsx("div",{className:`text-xs mt-1 ${s.sender===c?"text-blue-100":"text-gray-500"}`,children:$(s.timestamp)})]})},s.id)),e.jsx("div",{ref:w})]}),e.jsx("div",{className:"flex-shrink-0 border-t bg-gray-50 p-4",children:e.jsxs("form",{onSubmit:T,className:"space-y-3",children:[e.jsx("div",{children:e.jsx("input",{type:"text",value:c,onChange:s=>h(s.target.value),placeholder:"Your name",className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",maxLength:50})}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("textarea",{value:r,onChange:s=>{g(s.target.value),M()},onKeyPress:C,placeholder:"Type your message... (Enter to send, Shift+Enter for new line)",className:"w-full px-3 py-2 pr-10 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none",rows:2,maxLength:500}),e.jsx("button",{type:"button",onClick:()=>f(!j),className:"absolute right-2 top-2 text-gray-400 hover:text-gray-600",children:"😊"})]}),e.jsx("button",{type:"submit",disabled:!r.trim()||!c.trim()||o,className:`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${!r.trim()||!c.trim()||o?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:o?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):"Send"})]}),j&&e.jsx("div",{className:"absolute bottom-16 left-4 bg-white border border-gray-300 rounded-lg shadow-lg p-2 max-h-32 overflow-y-auto",children:e.jsx("div",{className:"grid grid-cols-8 gap-1",children:["😀","😂","😍","🤔","👍","👎","❤️","🔥","💯","🎉","🚀","⭐","💡","🎯","🔥","💪"].map(s=>e.jsx("button",{type:"button",onClick:()=>b(s),className:"p-1 hover:bg-gray-100 rounded text-lg",children:s},s))})}),L&&e.jsxs("div",{className:"text-xs text-gray-500 italic",children:[c," is typing..."]}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-500",children:[e.jsxs("span",{children:[r.length,"/500 characters"]}),e.jsx("span",{children:"Press Enter to send, Shift+Enter for new line"})]})]})}),!N&&e.jsx("div",{className:"flex-shrink-0 bg-yellow-50 border-t border-yellow-200 p-3",children:e.jsxs("div",{className:"flex items-center text-yellow-800",children:[e.jsx("div",{className:"w-2 h-2 bg-yellow-400 rounded-full mr-2"}),e.jsx("span",{className:"text-sm",children:"Reconnecting to chat..."})]})})]})}export{H as default};
//# sourceMappingURL=Chat-CNvK2cLi.js.map
