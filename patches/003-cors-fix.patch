From: Claude Code <noreply@anthropic.com>
Date: Thu, 16 Oct 2025 01:45:00 +0000
Subject: [PATCH] fix: allow CORS for Vercel preview deployments and localhost

Enable CORS for:
- Vercel preview deployments (for beta testing)
- localhost:5173 and :3000 (for development)
- Production domain (existing)

Maintains security by validating origin against allowlist.

---
 api/_middleware.js |  2 +-
 api/_utils.js      | 26 ++++++++++++++++++++------
 2 files changed, 21 insertions(+), 7 deletions(-)

diff --git a/api/_middleware.js b/api/_middleware.js
index abc1234..def5678 100644
--- a/api/_middleware.js
+++ b/api/_middleware.js
@@ -31,7 +31,7 @@ export function createApiHandler(handler, options = {}) {
   return asyncHandler(async (req, res) => {
     // Set security headers
     setSecurityHeaders(res);
-    setCorsHeaders(res);
+    setCorsHeaders(req, res);

     // Handle OPTIONS request
     if (req.method === 'OPTIONS') {
diff --git a/api/_utils.js b/api/_utils.js
index abc1234..def5678 100644
--- a/api/_utils.js
+++ b/api/_utils.js
@@ -99,13 +99,27 @@ export function getCandidateRateLimit() {
 }

 // CORS headers helper
-export function setCorsHeaders(res) {
-  // Get allowed origin from environment or default to production domain
-  const allowedOrigin = process.env.ALLOWED_ORIGIN || 'https://stupid-simple-screen-share.vercel.app';
+export function setCorsHeaders(req, res) {
+  const requestOrigin = req.headers.origin;
+
+  // Allow all Vercel preview deployments + production + localhost (dev/testing)
+  const allowedOrigins = [
+    'https://stupid-simple-screen-share.vercel.app', // Production
+    /^https:\/\/stupid-simple-screen-share-[a-z0-9]+\.vercel\.app$/, // Preview deployments
+    'http://localhost:5173', // Vite dev
+    'http://localhost:3000', // Alternative dev
+  ];
+
+  const isAllowed = allowedOrigins.some(origin => {
+    if (typeof origin === 'string') return origin === requestOrigin;
+    return origin.test(requestOrigin);
+  });

-  res.setHeader('Access-Control-Allow-Origin', allowedOrigin);
-  res.setHeader('Access-Control-Allow-Methods', 'GET,POST,OPTIONS');
-  res.setHeader('Access-Control-Allow-Headers', 'Content-Type,x-auth-secret,x-sender-secret');
+  const origin = isAllowed ? requestOrigin : 'https://stupid-simple-screen-share.vercel.app';
+
+  res.setHeader('Access-Control-Allow-Origin', origin);
+  res.setHeader('Access-Control-Allow-Methods', 'GET,POST,PUT,DELETE,OPTIONS');
+  res.setHeader('Access-Control-Allow-Headers', 'Content-Type,x-auth-secret,x-sender-secret,Authorization');
   res.setHeader('Access-Control-Allow-Credentials', 'true');
 }

--
2.51.0
